name: ğŸš€ è—¥ä¸¸æª¢æ¸¬ API - å»ºç½®èˆ‡æ¸¬è©¦

on:
  push:
    branches: [main, 'feature/*', 'feature-*'] 
    paths-ignore: 
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main] 

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: wenalyzer/pill-detector

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr,prefix=pr-
          type=raw,value=latest,enable={{is_default_branch}}
        flavor: |
          prefix=
          suffix=
    
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.ref == 'refs/heads/main' }}  # åªæœ‰mainåˆ†æ”¯æ¨é€åˆ°registry
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ğŸ›¡ï¸ å®¹å™¨å®‰å…¨æƒæ (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“Š ä¸Šå‚³å®¹å™¨å®‰å…¨æƒæå ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: container-security-reports-${{ github.run_id }}
        path: trivy-results.sarif
        
    - name: ğŸ“Š ä¸Šå‚³å®‰å…¨æƒæåˆ° GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'pull_request')  # åªåœ¨mainåˆ†æ”¯å’ŒPRä¸Šå‚³åˆ°Securityé é¢
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: Test Docker Image
      run: |
        echo "ğŸ§ª Testing the built Docker image..."
        
        # ä½¿ç”¨ç¬¬ä¸€å€‹æ¨é€çš„æ¨™ç±¤é€²è¡Œæ¸¬è©¦
        TEST_IMAGE="${{ fromJSON(steps.meta.outputs.json).tags[0] }}"
        echo "Testing image: $TEST_IMAGE"
        
        # å•Ÿå‹•å®¹å™¨
        docker run -d --name test-container -p 8000:8000 "$TEST_IMAGE"
        
        # ç­‰å¾…å•Ÿå‹•
        echo "â³ Waiting for container to start..."
        sleep 30
        
        # æª¢æŸ¥å®¹å™¨ç‹€æ…‹
        if ! docker ps | grep test-container; then
          echo "âŒ Container failed to start"
          docker logs test-container
          exit 1
        fi
        
        # é¡¯ç¤ºå®¹å™¨æ—¥èªŒï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
        echo "ğŸ“‹ Container logs:"
        docker logs test-container
        
        # å¥åº·æª¢æŸ¥
        echo "ğŸ” Testing health endpoint..."
        for i in {1..20}; do
          if curl -s -f http://localhost:8000/health > /dev/null; then
            echo "âœ… Health check passed after ${i} attempts"
            break
          fi
          echo "â³ Attempt $i/20, retrying in 5s..."
          sleep 5
          if [ $i -eq 20 ]; then
            echo "âŒ Health check failed"
            docker logs test-container
            exit 1
          fi
        done
        
        # API æ¸¬è©¦
        echo "ğŸ” Testing endpoints..."
        curl -f http://localhost:8000/ || exit 1
        
        echo "ğŸ‰ All tests passed!"
        
        # âš¡ API æ•ˆèƒ½åŸºæº–æ¸¬è©¦
        echo "âš¡ åŸ·è¡Œ API æ•ˆèƒ½åŸºæº–æ¸¬è©¦..."
        
        # å»ºç«‹ benchmark å ±å‘Šæª”æ¡ˆ
        echo "# ğŸš€ API æ•ˆèƒ½åŸºæº–æ¸¬è©¦å ±å‘Š" > benchmark_report.md
        echo "" >> benchmark_report.md
        echo "**æ¸¬è©¦æ™‚é–“**: $(date)" >> benchmark_report.md
        echo "**æ¸¬è©¦ç’°å¢ƒ**: GitHub Actions Ubuntu" >> benchmark_report.md
        echo "" >> benchmark_report.md
        echo "## ğŸ“Š æª¢æ¸¬ API æ•ˆèƒ½æ¸¬è©¦" >> benchmark_report.md
        echo "" >> benchmark_report.md
        echo "| æ¸¬è©¦æ¬¡æ•¸ | éŸ¿æ‡‰æ™‚é–“ | ç‹€æ…‹ |" >> benchmark_report.md
        echo "|---------|----------|------|" >> benchmark_report.md
        
        # æ•ˆèƒ½æ¸¬è©¦ä¸¦è¨˜éŒ„çµæœ - æ¸¬è©¦å¯¦éš›æª¢æ¸¬ API
        total_time=0
        success_count=0
        for i in {1..5}; do
          start_time=$(date +%s%N)
          # ä½¿ç”¨ç©©å®šçš„æ¸¬è©¦åœ–ç‰‡ URL (Form æ ¼å¼)
          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/detect \
            -F "image_url=https://httpbin.org/image/jpeg")
          end_time=$(date +%s%N)
          response_time=$(( (end_time - start_time) / 1000000 ))
          
          if [ "$http_code" = "200" ]; then
            status="âœ… æˆåŠŸ"
            total_time=$((total_time + response_time))
            success_count=$((success_count + 1))
          else
            status="âŒ å¤±æ•—($http_code)"
          fi
          
          echo "| ç¬¬ $i æ¬¡ | ${response_time}ms | $status |" >> benchmark_report.md
          echo "   ç¬¬ $i æ¬¡: ${response_time}ms - $status"
        done
        
        # è¨ˆç®—å¹³å‡å€¼
        if [ $success_count -gt 0 ]; then
          avg_time=$((total_time / success_count))
        else
          avg_time=0
        fi
        
        echo "" >> benchmark_report.md
        echo "## ğŸ“ˆ çµ±è¨ˆçµæœ" >> benchmark_report.md
        echo "" >> benchmark_report.md
        echo "- **å¹³å‡éŸ¿æ‡‰æ™‚é–“**: ${avg_time}ms" >> benchmark_report.md
        echo "- **ç¸½æ¸¬è©¦æ¬¡æ•¸**: 5 æ¬¡" >> benchmark_report.md
        echo "- **æˆåŠŸæ¬¡æ•¸**: ${success_count} æ¬¡" >> benchmark_report.md
        echo "- **æˆåŠŸç‡**: $((success_count * 100 / 5))%" >> benchmark_report.md
        
        if [ $success_count -eq 0 ]; then
          echo "- **æ•ˆèƒ½è©•ç´š**: ğŸ”´ æ¸¬è©¦å¤±æ•—" >> benchmark_report.md
          echo "âŒ æ•ˆèƒ½æ¸¬è©¦: å…¨éƒ¨å¤±æ•—"
        elif [ $avg_time -lt 2000 ]; then
          echo "- **æ•ˆèƒ½è©•ç´š**: ğŸŸ¢ å„ªç§€ (< 2s)" >> benchmark_report.md
          echo "âœ… æ•ˆèƒ½æ¸¬è©¦: å„ªç§€ (å¹³å‡ ${avg_time}ms)"
        elif [ $avg_time -lt 5000 ]; then
          echo "- **æ•ˆèƒ½è©•ç´š**: ğŸŸ¡ è‰¯å¥½ (< 5s)" >> benchmark_report.md
          echo "âœ… æ•ˆèƒ½æ¸¬è©¦: è‰¯å¥½ (å¹³å‡ ${avg_time}ms)"
        else
          echo "- **æ•ˆèƒ½è©•ç´š**: ğŸ”´ éœ€è¦å„ªåŒ– (> 5s)" >> benchmark_report.md
          echo "âš ï¸ æ•ˆèƒ½æ¸¬è©¦: éœ€è¦å„ªåŒ– (å¹³å‡ ${avg_time}ms)"
        fi
        
        echo "" >> benchmark_report.md
        echo "---" >> benchmark_report.md
        echo "*æ­¤å ±å‘Šç”± GitHub Actions è‡ªå‹•ç”¢ç”Ÿ*" >> benchmark_report.md
        
        # é¡¯ç¤ºå ±å‘Šå…§å®¹
        echo ""
        echo "ğŸ“Š å®Œæ•´ Benchmark å ±å‘Š:"
        cat benchmark_report.md
    
    - name: ğŸ“Š ä¸Šå‚³ Benchmark å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-report-${{ github.run_id }}
        path: benchmark_report.md
    
    - name: Cleanup test container
      if: always()
      run: |
        docker stop test-container || true
        docker rm test-container || true
    
    - name: Build Summary
      if: always()
      run: |
        echo "## ğŸš€ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ—ï¸ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ³ Built Images" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.meta.outputs.tags }}" | sed 's/,/\n/g' >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ§ª Test Status" >> $GITHUB_STEP_SUMMARY
        echo "- Integration Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸš€ Quick Start" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "docker run -p 8000:8000 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "curl http://localhost:8000/health" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY