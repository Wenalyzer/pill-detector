name: ðŸš€ å¤šç’°å¢ƒéƒ¨ç½²

on:
  push:
    branches:
      - main 
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      environment:
        description: 'é¸æ“‡éƒ¨ç½²ç’°å¢ƒ'  
        required: true
        default: 'production'
        type: choice
        options:
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: wenalyzer/pill-detector

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      deploy_url: ${{ steps.env.outputs.deploy_url }}
    
    steps:
    - name: ðŸŽ¯ æ±ºå®šéƒ¨ç½²ç’°å¢ƒ
      id: env
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
          ENVIRONMENT="production"
        else
          echo "âŒ æœªæ”¯æ´çš„åˆ†æ”¯ï¼Œè·³éŽéƒ¨ç½²"
          exit 1
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        
        # è¨­å®šå€‹äººä¼ºæœå™¨éƒ¨ç½²
        echo "deploy_url=https://detect-api-self.wenalyzer.xyz" >> $GITHUB_OUTPUT
        echo "deploy_type=personal-server" >> $GITHUB_OUTPUT

  deploy:
    needs: determine-environment
    runs-on: self-hosted  # åœ¨ä½ çš„å€‹äººä¼ºæœå™¨ä¸ŠåŸ·è¡Œéƒ¨ç½²
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
    - name: ðŸ“¦ éƒ¨ç½²åˆ° ${{ needs.determine-environment.outputs.environment }}
      run: |
        # ç”¢ç”Ÿæ™‚é–“æˆ³æ¨™ç±¤
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        DEPLOY_TAG="deploy-${TIMESTAMP}"
        
        echo "ðŸš€ éƒ¨ç½²åˆ°ç’°å¢ƒ: ${{ needs.determine-environment.outputs.environment }}"
        echo "ðŸŒ éƒ¨ç½² URL: ${{ needs.determine-environment.outputs.deploy_url }}"
        echo "ðŸ·ï¸ æ˜ åƒæ¨™ç±¤: $DEPLOY_TAG"
        
        echo "ðŸ  éƒ¨ç½²åˆ°å€‹äººä¼ºæœå™¨..."
        # ä½¿ç”¨æ™‚é–“æˆ³æ¨™ç±¤é¿å…è¡çª
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$DEPLOY_TAG
        
        # åœæ­¢èˆŠå®¹å™¨ä¸¦å•Ÿå‹•æ–°å®¹å™¨
        docker stop pill-detector-main || true
        docker rm pill-detector-main || true
        docker run -d --name pill-detector-main -p 8000:8000 \
          --restart unless-stopped \
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$DEPLOY_TAG
        echo "âœ… å€‹äººä¼ºæœå™¨éƒ¨ç½²å®Œæˆ (æ¨™ç±¤: $DEPLOY_TAG)"
    
    - name: ðŸ” éƒ¨ç½²å¾Œå¥åº·æª¢æŸ¥
      run: |
        echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
        sleep 30
        
        # å¥åº·æª¢æŸ¥
        HEALTH_URL="${{ needs.determine-environment.outputs.deploy_url }}/health"
        echo "ðŸ©º æª¢æŸ¥å¥åº·ç‹€æ…‹: $HEALTH_URL"
        
        # å¯¦éš›å¥åº·æª¢æŸ¥
        if ! curl -f $HEALTH_URL; then
          echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—"
          exit 1
        fi
        echo "âœ… å¥åº·æª¢æŸ¥é€šéŽ"
        echo "ðŸ“ Note: git tag æœƒè‡ªå‹•è§¸ç™¼ Cloud Run éƒ¨ç½²"
    
    - name: ðŸ“Š éƒ¨ç½²æ‘˜è¦
      run: |
        echo "## ðŸš€ éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ç’°å¢ƒ**: ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æœå‹™ URL**: ${{ needs.determine-environment.outputs.deploy_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ§ª å¿«é€Ÿæ¸¬è©¦" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "curl ${{ needs.determine-environment.outputs.deploy_url }}/health" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY