# 藥丸檢測系統 - 技術實現記錄

## 📖 項目概述

本項目是一個基於 RF-DETR 深度學習模型的藥丸檢測 API 系統，經歷了從 PyTorch 研究原型到輕量化生產環境的完整技術演進。通過系統性的架構重構和性能優化，實現了**依賴最小化**、**性能提升**和**部署友好**的目標。

## 🔧 主要實現

### 🎯 **模型轉換與優化**
- **起點**: RF-DETR PyTorch 模型 (.pth 格式)
- **終點**: ONNX 推理實現 (無 PyTorch 依賴)
- **收益**: 移除 PyTorch 依賴，簡化部署

### 🔧 **前後處理重構**
- **挑戰**: 失去 torch/torchvision/opencv 依賴後需要重新實現完整流程
- **解決方案**: 使用 Pillow + NumPy 重新實現
- **技術改進**: 解決了預處理操作順序的精度問題

### 🏷️ **智能標註系統**
- **痛點**: 檢測結果標籤重疊遮擋問題
- **創新**: 開發了距離優化 + 重疊控制的智能標註算法
- **效果**: 10% 重疊閾值 + 距離優化的智能定位算法

### 📦 **容器化實現**
- **成果**: Docker 鏡像大小 850MB
- **方法**: 多階段構建 + 依賴最小化 + 輕量基礎鏡像

## 🔄 技術演進歷程

### **階段一：PyTorch 原型 (研究階段)**
```
PyTorch (.pth) + 完整深度學習生態
├── 優點：標準實現，精度保證
└── 缺點：依賴重，部署複雜，資源消耗大
```

### **階段二：ONNX 轉換 (中間態)**
```
ONNX 模型 + OpenCV 前處理
├── 進步：移除 PyTorch 依賴
├── 問題：預處理順序錯誤導致精度損失
└── 教訓：操作順序對精度的關鍵影響
```

### **階段三：純數學實現 (技術驗證)**
```
ONNX 模型 + numpy數學實現
├── 優點：只有numpy依賴，完美精度
├── 缺點：效率極低，實現複雜
└── 價值：驗證了可行性，為最終方案奠定基礎
```

### **階段四：Pillow 實現 (最終版本)**
```
ONNX 模型 + Pillow 實現
├── 技術要點：resize → to_tensor → normalize 操作順序
├── 技術特點：在原始像素域 (uint8) 進行 resize
├── 技術優點：避免標準化數據的精度損失
└── 維護性：代碼清晰，邏輯直觀
```

## 🔧 技術細節

### **1. 預處理操作順序**
```python
# ❌ 錯誤順序 (精度損失)
image → to_tensor → normalize → resize

# ✅ 採用方案 (精度保證)  
image → resize → to_tensor → normalize
```
**洞察**: 在原始像素域 (uint8 [0,255]) 進行幾何變換，避免對浮點標準化數據的精度影響

### **2. 後處理算法設計**
```python
# 採用方案：每位置最高分類
300個位置 → 各選最佳類別 → 閾值過濾 → Top-K選擇
```
**優勢**: 避免同位置多檢測，符合物理直覺，算法邏輯更清晰

### **3. 智能標註算法**
經過多次迭代優化：
- **v1.0**: 基礎修復 - 解決文字尺寸計算錯誤
- **v2.0**: 重疊閾值控制 - 從絕對重疊到 10% 閾值
- **v3.0**: 距離優化策略 - 人類視覺友好的標籤定位

**最終算法特點**:
- 10% 重疊閾值：精確控制，允許合理重疊
- 距離優化：標籤優先選擇遠離其他檢測框的位置
- 8個候選位置：核心位置選擇，減少計算複雜度
- 密集場景優化：在複雜重疊情況下表現尚可

## 📊 性能表現

### **系統組件**
- **預處理**: Pillow resize + tensor 轉換
- **模型推理**: ONNX Runtime 優化推理
- **後處理**: 座標轉換 + 結果過濾
- **智能標註**: 重疊避免 + 距離優化算法

### **資源使用**
- **Docker 鏡像**: 850MB (輕量化構建)
- **依賴數量**: 9個核心套件 (依賴最小化)

### **部署優化**
- **啟動策略**: 圖優化降級 + 預載入應用
- **並發配置**: 100 併發請求限制

## 🏗️ 最終架構設計

### **模組化分層架構**
```
FastAPI (API 層)
    ↓
DetectionService (業務邏輯層)
    ↓
PillDetector (核心檢測引擎) + ImageAnnotator (可視化組件)
    ↓
ONNX Runtime (推理引擎) + Pillow (圖像處理)
```

### **API 架構詳解**

#### **🌐 FastAPI 應用層 (`main.py`)**
```python
# 核心特性
├── 非同步生命週期管理 (lifespan)
├── 統一檢測端點 (/detect)
├── 速率限制中間件 (10 requests/minute)
├── CORS 中間件支持
└── 錯誤處理
```

**端點設計**：
- `GET /` - API 狀態和功能介紹
- `GET /health` - 健康檢查與服務狀態  
- `POST /detect` - **統一檢測端點**（支援 URL 和檔案上傳）
- `GET /test` - 網頁測試介面

- **統一輸入處理**：單一端點同時支援 URL 和檔案上傳
- **防護機制**：速率限制防止濫用，檔案大小限制防止資源耗盡

#### **🔄 DetectionService 業務邏輯層 (`detection_service.py`)**
```python
# 職責分離
├── 輸入源處理 (URL 下載 vs 檔案上傳)
├── 異常處理與日誌記錄
├── 性能監控與統計
└── 組件協調 (檢測器 + 標註器)
```

**核心功能**：
- **統一異常處理**：網路錯誤、檔案格式錯誤、推理失敗的分層處理
- **性能追蹤**：分階段計時（下載、預處理、推理、後處理、標註）

#### **🎯 PillDetector 核心引擎 (`pill_detector.py`)**
```python
# 職責專精
├── ONNX 模型載入與配置
├── 優雅預處理流程
├── 高效推理執行
└── 智能後處理算法
```

**技術特點**：
- **預處理管道**：resize → to_tensor → normalize 順序
- **後處理算法**：每位置最高分類策略，避免重複檢測

#### **🏷️ ImageAnnotator 視覺化組件 (`image_annotator.py`)**
```python
# 智能標註算法
├── 重疊檢測與避免 (10% 閾值)
├── 距離優化定位
├── 高品質 PIL 渲染
└── 字體載入與管理
```

**演算法創新**：
- **8個候選位置**：上下左右 + 四個角落的智能選擇
- **綜合評分機制**：重疊懲罰 - 距離獎勵 × 0.1
- **早期退出策略**：單一重疊 > 10% 立即跳過
- **強制備援機制**：極端情況的容錯處理

### **🔧 ASGI Server配置 (`uvicorn.prod.py`)**
```python
# 生產環境配置
├── uvloop 事件循環優化
└── httptools HTTP 解析器
```

### **📦 容器化架構 (`Dockerfile`)**
```dockerfile
# 多階段構建
├── 構建階段：依賴編譯 + wheel 打包
├── 運行階段：最小化基礎鏡像
└── 安全設計：非 root 用戶運行
```

### **⚙️ 統一配置管理 (`config.py`)**
```python
# 配置分類
├── API 服務設定 (端點、CORS、速率限制)
├── 模型推理設定 (ONNX Runtime 配置)
├── 圖像處理設定 (尺寸、標準化參數)
├── 檢測參數設定 (閾值、Top-K)
├── 視覺化設定 (顏色、字體、線條粗細)
└── 部署設定 (超時、記憶體限制、日誌)
```

### **核心技術棧**
- **API 框架**: FastAPI + uvicorn (ASGI)
- **推理引擎**: ONNX Runtime 
- **圖像處理**: Pillow + NumPy
- **容器化**: Docker multi-stage build
- **部署**: 容器化部署

## 🔧 技術實現

### **1. 依賴精簡**
移除不必要的依賴：
```bash
# 移除的重型依賴
❌ torch, torchvision, opencv-python, supervision

# 保留的核心依賴  
✅ onnxruntime, pillow, numpy, fastapi
```

### **2. 容器化實現**
- **多階段構建**: 分離構建和運行環境
- **基礎鏡像**: python:3.12-slim 
- **層級合併**: 合併 RUN 命令，減少層數

### **3. 配置管理**
- **統一配置**: 所有參數集中在 config.py
- **環境適配**: 開發/生產環境分離
- **參數調整**: ONNX Runtime 性能配置

## 🎯 專案特點

### **技術實現**
- **模型部署**: ONNX Runtime 推理實現
- **架構設計**: 模組化分層結構

### **部署特性**
- **容器化**: Docker 多階段構建
- **模組化**: 組件職責分離清晰
- **可擴展**: 支援新類別添加

## 📝 總結

本專案實現了 RF-DETR 模型的 ONNX 部署，包含完整的 API 服務和 Web 介面。採用模組化架構設計，支援容器化部署。
